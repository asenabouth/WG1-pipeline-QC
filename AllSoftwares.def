Bootstrap: docker
From: conda/miniconda3

%environment
	export PATH=/opt/popscle/bin/:/opt:/opt/scSplit:/usr/games:/opt/bedtools2/bin:/usr/local/envs/py36/bin:/opt/souporcell:/opt/souporcell/troublet/target/release:/usr/local/condabin:/opt/minimap2-2.7:/root/.cargo/bin:/opt/vartrix-v1.1.3-x86_64-linux/:/opt/freebayes/scripts:/opt/freebayes:/opt/vcflib/bin:/opt/vcflib/scripts:$PATH
    export PYTHONPATH=/usr/local/lib/python3.6/site-packages/
    export LC_ALL=C 
    alias python=python3


%post 
    # bash
    apt update
    yes | apt-get install wget
    yes | apt-get install build-essential
	yes | apt-get install curl
	yes | /usr/local/bin/conda create -n py36 python=3.6.8
    cd /opt
    CARGO_HOME=/opt/.cargo RUSTUP_HOME=/opt/.cargo bash -c 'curl https://sh.rustup.rs -sSf | sh -s -- -y'
        . /opt/.cargo/env
        which cargo
        rustup default stable
    yes | apt-get install git
    eval "$(conda shell.bash hook)"
	conda activate py36
        yes | apt-get install libncurses5-dev
        yes | apt-get install zlib1g-dev
        yes | apt-get install libbz2-dev
        yes | apt-get install liblzma-dev
        yes | apt-get install cmake
        yes | apt-get install zlib1g
        yes | apt-get install zlib1g-dev
        apt-get install -y pkg-config
        apt-get install -y libcurl4-openssl-dev

    cd /opt
        wget https://github.com/vcftools/vcftools/releases/download/v0.1.16/vcftools-0.1.16.tar.gz
        tar xvf vcftools-0.1.16.tar.gz
        rm vcftools-0.1.16.tar.gz
        cd vcftools-0.1.16
        ./configure
        make
        make install

        cd /opt
        wget https://github.com/lh3/minimap2/archive/v2.7.tar.gz
            tar -xzvf v2.7.tar.gz
            cd minimap2-2.7
            make
        cd /opt
        wget https://github.com/arq5x/bedtools2/releases/download/v2.28.0/bedtools-2.28.0.tar.gz
            tar -zxvf bedtools-2.28.0.tar.gz
            cd bedtools2
            make
        cd /opt
        git clone https://github.com/wheaton5/souporcell.git
            cd souporcell/troublet
            cargo build --release
            cd /opt/souporcell/souporcell
            cargo build --release
        cd /opt
        wget https://github.com/10XGenomics/vartrix/releases/download/v1.1.3/vartrix-v1.1.3-x86_64-linux.tar.gz
            tar xzvf vartrix-v1.1.3-x86_64-linux.tar.gz
            rm vartrix-v1.1.3-x86_64-linux.tar.gz

        yes | /usr/local/envs/py36/bin/pip install pysam
        /usr/local/envs/py36/bin/pip install pyvcf
        /usr/local/envs/py36/bin/pip install numpy
        /usr/local/envs/py36/bin/pip install scipy
        /usr/local/envs/py36/bin/pip install pystan==2.17.1.0
        /usr/local/envs/py36/bin/pip install pyfaidx
        /usr/local/envs/py36/bin/pip install scikit-learn
        /usr/local/envs/py36/bin/pip install pandas
        /usr/local/envs/py36/bin/pip install matplotlib
        /usr/local/envs/py36/bin/pip install vireoSNP
        /usr/local/envs/py36/bin/pip install cellSNP
        /usr/local/envs/py36/bin/pip install scikit-image
        /usr/local/envs/py36/bin/pip install numba
        /usr/local/envs/py36/bin/pip install annoy
        /usr/local/envs/py36/bin/pip install umap-learn
        /usr/local/envs/py36/bin/pip install scrublet
        /usr/local/envs/py36/bin/pip install h5py
        /usr/local/envs/py36/bin/pip install snakemake
        
        cd /opt
        wget --no-check-certificate 'https://docs.google.com/uc?export=download&id=1QVUBY01g7NZSWpdjB6b6ubjBNEcWArcM' -O scrublet_pipeline.py

        cd /opt
        wget https://github.com/samtools/htslib/releases/download/1.10.2/htslib-1.10.2.tar.bz2
            tar xvfj htslib-1.10.2.tar.bz2
            cd htslib-1.10.2
            ./configure
            make
            make install
        cd /opt
            wget https://github.com/samtools/samtools/releases/download/1.10/samtools-1.10.tar.bz2
            tar xvfj samtools-1.10.tar.bz2
            rm samtools-1.10.tar.bz2
            cd samtools-1.10
            ./configure
            make
            make install
        cd /opt
            wget https://github.com/samtools/bcftools/releases/download/1.10.2/bcftools-1.10.2.tar.bz2
            tar xvfj bcftools-1.10.2.tar.bz2
            rm bcftools-1.10.2.tar.bz2
            cd bcftools-1.10.2
            ./configure
            make
            make install
        cd /opt
    git clone https://github.com/ekg/freebayes.git
    
    wget https://github.com/ekg/freebayes/releases/download/v1.3.1/freebayes-v1.3.1
		mv freebayes-v1.3.1 freebayes/freebayes
		chmod 777 freebayes/freebayes

    cd /opt
    git clone --recursive https://github.com/vcflib/vcflib.git
        cd vcflib
        make
    
    cd /opt
    wget http://ftp.gnu.org/gnu/parallel/parallel-latest.tar.bz2
        tar xjf parallel-latest.tar.bz2
        cd parallel-*
        ./configure && make
        make install
    
    cd /opt
    git clone https://github.com/jon-xu/scSplit
        chmod 777 /opt/scSplit/scSplit
        echo 'alias scSplit=/opt/scSplit/scSplit' >> $SINGULARITY_ENVIRONMENT

    cd /opt
    git clone https://github.com/statgen/popscle.git
        cd popscle
        # sed -i 's/set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -O3 -pthread")/set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -O3 -pthread --std=c++11")/g' CMakeLists.txt
        cat CMakeLists.txt
        mkdir build
        cd build
        cmake ..
        make
    echo 'alias popscle=/opt/popscle/bin/popscle' >> $SINGULARITY_ENVIRONMENT
    
%labels 
    Author Drew Neavin

